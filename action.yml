name: 'Terraform PR Commenter (Jimdo)'
description: 'Adds opinionated comments to a PR from Terraform fmt/init/plan output'
author: 'Jimdo'
branding:
  icon: 'git-pull-request'
  color: 'purple'
inputs:
  commenter_type:
    description: 'The type of comment. Options: [fmt, init, plan]'
    required: true
  commenter_input:
    description: 'The comment to post from a previous step output'
    required: true
  commenter_exitcode:
    description: 'The exit code from a previous step output'
    required: true
  commenter_comment:
    description: 'An optional comment to add to the headline.'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Write input to file
      shell: bash
      run: |
        mkdir -p /tmp/terraform-pr-commenter
        echo "${{ inputs.commenter_input }}" > /tmp/terraform-pr-commenter/input.txt

    - name: Run Docker container
      shell: bash
      run: |
        cd ${{ github.action_path }}
        docker build -t terraform-pr-commenter .
        docker run --rm \
          -v /tmp/terraform-pr-commenter:/tmp/terraform-pr-commenter \
          -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
          -e TF_WORKSPACE="${TF_WORKSPACE:-default}" \
          -e EXPAND_SUMMARY_DETAILS="${EXPAND_SUMMARY_DETAILS:-true}" \
          -e HIGHLIGHT_CHANGES="${HIGHLIGHT_CHANGES:-true}" \
          -e GITHUB_EVENT_PATH="${GITHUB_EVENT_PATH}" \
          -v "${GITHUB_EVENT_PATH}":"${GITHUB_EVENT_PATH}" \
          terraform-pr-commenter \
          ${{ inputs.commenter_type }} \
          ${{ inputs.commenter_exitcode }} \
          "${{ inputs.commenter_comment }}"
